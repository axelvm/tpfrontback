<link rel="stylesheet" type="text/CSS" href="style.css">
<script src="resources/jquery-3.3.1.min.js"></script>
<link rel="stylesheet" href="resources/jquery-ui-1.12.1.custom/jquery-ui.min.css">
<link rel="stylesheet" type="text/CSS" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
<script src="resources/jquery-ui-1.12.1.custom/external/jquery/jquery.js"></script>
<script src="resources/jquery-ui-1.12.1.custom/jquery-ui.min.js"></script>
<script>


    // addresses pour ajax
    var address_getP = 'http://localhost/yves/yves/tpfrontback/resources/data.php?action=getP';
    var resources_address = 'http://localhost/yves/yves/tpfrontback/resources/';
    // Commentaire par défaut
    var jP = $("<div>").html("<p>Nouveau</p>").addClass("zoneComment");

    function add_contenu(contenu) {
        // ajoute le contenu j'espere
        // ne fait que prepend
        var jNextP = jP.clone();
        if (contenu) {
            jNextP.html("<p>" + contenu + "</p>");
            var address = resources_address + "data.php?action=addP&ordre=1&contenu=" + contenu + "";
            console.log("passe par if de add contenu");
            console.log(address);
            $.get(address, function () {
                console.log("nouvelle entre dans la bdd");
            });
        }
        else {
            $.post(resources_address + "data.php?action=addP&ordre=1&contenu=" + "Nouveau", function () {
                console.log("nouveau contenu par defaut dans la bdd");
            });

        }
        $("#contenu").prepend(jNextP);
        jNextP.append("<img class='croix' src='resources/croix.png' />"); //insertion de la croix pouvant supprimer le commentaire

    }

    //Composant Bouton Plus qui insère les divs contenant les commentaires
    var composantBtnP = $("<div>")
        .addClass("btnPlus row")
        .data("top", true)
        .append($("<input class='btn btn-info col-sm-2 offset-2' type='button'/>")
            .val("+")
            .click(function () {
                var contenu = $(this).next().val();
                $(this).next().val("");
                add_contenu(contenu); //insertion de la croix pouvant supprimer le commentaire
            })
        )
        .append(//Champs texte permettant d'écrire le commentaire
            $("<input class='col-sm-5 form-control' type='text' placeholder='ecrivez un commentaire'/>")
        );


    // 1) ajouter les éléments d'interaction à la page
    $(document).ready(function () {
        $("#contenu")
            .before(composantBtnP.clone(true)
            );
    });


    // 2)  Passage en mode édition des P. insérés
    // clic => le P. se transforme en textarea avec le mm contenu
    // "ENTREE" => le textarea redevient un P. avec le mm contenu

    $(document).ready(function () {
        $.get(address_getP, function (data) {
            var table = JSON.parse(data);
            $.each(table.paragraphes, function (index, element) {
                    $("#contenu")
                        .append(jP.clone(true).html("<p>" + element.contenu + "</p>"))
                        .append("<img class='croix' src='resources/croix.png' />");
                }
            )
            ;
        })
    });
    // Réagir aux clicks sur les P. (y compris futurs !)
    $(document).on("click", "#contenu p", function () {
        // fonction appelee lors d'un clic sur un P
        // dans le div de contenu
        var contenu = $(this).html(); // recup contenu
        var jTa = $("<textarea class='form-control'>")
            .val(contenu)
            .data("contenuInitial", contenu);
        // prépa txtarea
        // AJOUT d'une méta-donnée
        $(this).replaceWith(jTa); // insertion txtarea
        jTa.select();
    });


    // Réagir aux appuis sur ENTREE dans les txtarea
    $(document).on("keydown", "#contenu textarea", function (contexte) {

        //afficher le code de la touche appuyée
        //console.log(contexte.which);
        //insérer le nouveau contenu si la touche ENTRER est appuyée pendant la réédition
        if (contexte.which != 13) return;
        var contenu = $(this).val(); // recup contenu
        var jPar = $("<p>").html(contenu); // prépa P
        $(this).replaceWith(jPar); // insertion P
        // TODO maj de la bdd
    });

    // Réagir aux appuis sur ENTREE dans les txtarea
    $(document).on("keydown", "#contenu textarea", function (contexte) {
        // quelle est la touche appuyée ??
        // en JQuery, tous les gestionnaires d'evenements
        // sont destinataires d'un objet event en param.
        // prop code ascii de la touche : code vaudra "Enter"

        console.log(contexte.which);
        if (contexte.which != 13) return;


        $(document).on("click", ".croix", function () {
            console.log("on supprime le commentaire");
        });

        // 3) "ESC" => toutes les éditions en cours sont annulées
        // les contenus des textarea sont restaurés aux valeurs
        // initiales - elles avaient été stockées par la méthode .data()
        // itérer sur un ensemble : $(sel).each(fonction)
        // ======
        //     =

        $(document).keyup(function (contexte) {
            if (contexte.which != 27) return;

            // parcours de tous les textarea
            $("#contenu textarea").each(function () {
                // $(this) dénote le txtarea en cours de parcours
                // permet de récupérer le contenu initial
                var contenu = $(this).data("contenuInitial");
                var jPar = $("<p>").html(contenu); // prépa P
                $(this).replaceWith(jPar); // insertion P
            });

        });


        //fonction de trie des commentaires en jQuery UI
        /*$( function() {
        $( "#contenu" ).sortable({
          revert: true
        });*/

        // DEBUG
        $(document).on("mouseover", "#contenu *", function () {
            console.log($(this).data());
        });

    });


</script>

<body>
<div class="site-container">
    <div id="contenu">

    </div>
</div>
</body>
