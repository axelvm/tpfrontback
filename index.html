<link rel="stylesheet" type="text/CSS" href="style.css">
<script src="resources/jquery-3.3.1.min.js"></script>
<link rel="stylesheet" href="resources/jquery-ui-1.12.1.custom/jquery-ui.min.css">
<link rel="stylesheet" type="text/CSS" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
<script src="resources/jquery-ui-1.12.1.custom/external/jquery/jquery.js"></script>
<script src="resources/jquery-ui-1.12.1.custom/jquery-ui.min.js"></script>
<script>


    // addresses pour ajax
    var address_getP = 'http://localhost/yves/yves/tpfrontback/resources/data.php?action=getP';
    var resources_address = 'http://localhost/yves/yves/tpfrontback/resources/';
    // Commentaire par défaut
    var jP = $("<div>").html("<p>Nouveau</p>").addClass("zoneComment");

    function add_contenu(contenu) {
        var jNextP = jP.clone();
        if (contenu) {
            jNextP.html("<p>" + contenu + "</p>");
            var address = resources_address + "data.php?action=addP&ordre=1&contenu=" + contenu + "";
            console.log("passe par if de add contenu");
            console.log(address);
            $.get(address, function (data) {
                var table = JSON.parse(data);
                console.log("nouvelle entre dans la bdd");
                jNextP.attr('id', table.id);
            });
        }
        else {
            $.get(resources_address + "data.php?action=addP&ordre=1&contenu=" + "Nouveau", function (data) {
                table = JSON.parse(data);
                jNextP.attr('id', table.id);
                console.log("nouveau contenu par defaut dans la bdd");
            });

        }
        $("#contenu").prepend(jNextP);
        jNextP.append("<img class='croix' src='resources/croix.png' />"); //insertion de la croix pouvant supprimer le commentaire
    }

    function maj_contenu(div) {
        $(div).children('p').each(function (index, element) {
            var ordre = index + 1

        });
    }
    var composantBtnP = $("<div>")
        .addClass("btnPlus row")
        .data("top", true)
        .append($("<input class='btn btn-info col-sm-2 offset-2' type='button'/>")
            .val("+")
            .click(function () {
                var contenu = $(this).next().val();
                $(this).next().val("");
                add_contenu(contenu); //insertion de la croix pouvant supprimer le commentaire
            })
        )
        .append(//Champs texte permettant d'écrire le commentaire
            $("<input class='col-sm-5 form-control' type='text' placeholder='ecrivez un commentaire'/>")
        );



    // 1) ajouter les éléments d'interaction à la page
    $(document).ready(function () {
        $("#contenu")
            .before(composantBtnP.clone(true)
            );
    });

    $(document).ready(function () {
        $.get(address_getP, function (data) {
            var table = JSON.parse(data);
            $.each(table.paragraphes, function (index, element) {
                    $("#contenu")
                        .append(jP.clone(true).html("<p>" + element.contenu + "</p>"))
                        .append("<img class='croix' src='resources/croix.png' />");
                }
            )
            ;
        })
    });

    $(document).on("click", "#contenu p", function () {
        var contenu = $(this).html();
        var jTa = $("<textarea class='form-control'>")
            .val(contenu)
            .data("contenuInitial", contenu);

        $(this).replaceWith(jTa);
        jTa.select();
    });


    $(document).on("keydown", "#contenu textarea", function (contexte) {
        if (contexte.which != 13) return;
        var contenu = $(this).val(); // recup contenu
        var jPar = $("<p>").html(contenu); // prépa P
        $(this).replaceWith(jPar); // insertion P
        // TODO maj de la bdd
    });

    $(document).on("keydown", "#contenu textarea", function (contexte) {
        console.log(contexte.which);
        if (contexte.which != 13) return;
        $(document).on("click",    // Réagir aux appuis sur ENTREE dans les txtarea
            ".croix", function () {
            console.log("on supprime le commentaire");
        });


        $(document).keyup(function (contexte) {
            if (contexte.which != 27) return;
            $("#contenu textarea").each(function () {
                var contenu = $(this).data("contenuInitial");
                var jPar = $("<p>").html(contenu); // prépa P
                $(this).replaceWith(jPar); // insertion P
            });

        });

        $(document).on("mouseover", "#contenu *", function () {
            console.log($(this).data());
        });

    });


</script>

<body>
<div class="site-container">
    <div id="contenu">

    </div>
</div>
</body>
