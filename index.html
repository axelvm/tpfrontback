<link rel="stylesheet" type="text/CSS" href="style.css">
<script src="resources/jquery-3.3.1.min.js"></script>
<link rel="stylesheet" href="resources/jquery-ui-1.12.1.custom/jquery-ui.min.css">
<link rel="stylesheet" type="text/CSS" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
<script src="resources/jquery-ui-1.12.1.custom/external/jquery/jquery.js"></script>
<script src="resources/jquery-ui-1.12.1.custom/jquery-ui.min.js"></script>
<script>



//Variable contenant le commentaire pa défaut

var jP= $("<div>").html("<p>Nouveau</p>").addClass("zoneComment");

    var resources_address = 'http://localhost/yves/yves/tpfrontback/resources/';
    var address_update = 'http://localhost/yves/yves/tpfrontback/resources/data.php?action=updateP&id=2&contenu=test';
    var address_getP = 'http://localhost/yves/yves/tpfrontback/resources/data.php?action=getP'

    // TODO : préparer un "composant" boutonPlus
    // qui insère des P. en position haute ou basse
    // suivant une méta-donnée "position"


    var jP = $("<p>").html("Nouveau");

    var btn2 = $("<div>")
        .addClass("btn2")
        .append(
            $("<input type='button'/>")
                .val("+")
                .click(function () {
                    $.get(address_getP, function (data) {
                        var table = JSON.parse(data);
                        $.each(table.paragraphes, function (index, element) {
                            $("#contenu").append(jP.clone().html(element.contenu));
                        });
                    })
                }));

					// la zone d'insertion 
					// dépend de la méta-donnée "top"
					// portée par le composant 
					if ($(this).parent().data("top"))
						$("#contenu").prepend(jNextP); 
					else 
						$("#contenu").append(jNextP); 
				})
		)
		.append(
				$("<input type='text' />")
		); 

    var composantBtnP = $("<div>")
        .addClass("btnPlus")
        .data("top", true)
        .append(
            $("<input type='button'/>")
                .val("+")
                .click(function () {
                    var contenu = $(this).next().val();
                    $(this).next().val("");
                    var jNextP = jP.clone();
                    if (contenu) jNextP.html(contenu);

                    // la zone d'insertion
                    // dépend de la méta-donnée "top"
                    // portée par le composant
                    if ($(this).parent().data("top"))
                        $("#contenu").prepend(jNextP);
                    else
                        $("#contenu").append(jNextP);
                })
        )
        .append(
            $("<input type='text' />")
        );

	// 1) ajouter les éléments d'interaction à la page 
	$("#contenu")
		.before(composantBtnP.clone(true)
		)

	// 2)  Passage en mode édition des P. insérés 
	// clic => le P. se transforme en textarea avec le mm contenu 
	// "ENTREE" => le textarea redevient un P. avec le mm contenu 

        $(document).ready(function () {
            $.get(address_getP, function (data) {
                var table = JSON.parse(data);
                $.each(table.paragraphes, function (index, element) {
                        $("#contenu").append(jP.clone(true).html(element.contenu));
                    }
                )
                ;
            })
        });
	// Réagir aux clicks sur les P. (y compris futurs !) 
	$(document).on("click","#contenu p", function (){
		// fonction appelee lors d'un clic sur un P
		// dans le div de contenu 
		var contenu = $(this).html(); // recup contenu 
		var jTa = $("<textarea class='form-control'>")
					.val(contenu)
					.data("contenuInitial",contenu); 
		// prépa txtarea
		// AJOUT d'une méta-donnée 
		$(this).replaceWith(jTa); // insertion txtarea
		jTa.select();
	}); 

	//fonction permettant de réordonner les commentaires
    $("#contenu" ).sortable({
      revert: true
    });

    

	// Réagir aux appuis sur ENTREE dans les txtarea 
	$(document).on(	"keydown", "#contenu textarea", function (contexte){	

	//afficher le code de la touche appuyée	
		//console.log(contexte.which);
		//insérer le nouveau contenu si la touche ENTRER est appuyée pendant la réédition
		if (contexte.which != 13) return ;
		var contenu = $(this).val(); // recup contenu 
		var jPar = $("<p>").html(contenu); // prépa P
		$(this).replaceWith(jPar); // insertion P
	}); 

            $(this).replaceWith(jTa); // insertion txtarea
            jTa.focus(); // .select();

	// si la touche "ESC" => toutes les éditions en cours sont annulées
	// les contenus des textarea sont restaurés aux valeurs
	// initiales - elles avaient été stockées par la méthode .data()

        $("#contenu").sortable({
            revert: true
        });

        // Réagir aux appuis sur ENTREE dans les txtarea
        $(document).on("keydown", "#contenu textarea", function (contexte) {
            // quelle est la touche appuyée ??
            // en JQuery, tous les gestionnaires d'evenements
            // sont destinataires d'un objet event en param.
            // prop code ascii de la touche : code vaudra "Enter"

            console.log(contexte.which);
            if (contexte.which != 13) return;


	$(document).on("click", ".croix", function(){
		console.log("on supprime le commentaire");
	});

        // 3) "ESC" => toutes les éditions en cours sont annulées
        // les contenus des textarea sont restaurés aux valeurs
        // initiales - elles avaient été stockées par la méthode .data()
        // itérer sur un ensemble : $(sel).each(fonction)

        $(document).keyup(function (contexte) {
            if (contexte.which != 27) return;

            // parcours de tous les textarea
            $("#contenu textarea").each(function () {
                // $(this) dénote le txtarea en cours de parcours
                // permet de récupérer le contenu initial
                var contenu = $(this).data("contenuInitial");
                var jPar = $("<p>").html(contenu); // prépa P
                $(this).replaceWith(jPar); // insertion P
            });

        });


        //fonction de trie des commentaires en jQuery UI
        /*$( function() {
        $( "#contenu" ).sortable({
          revert: true
        });*/

        // DEBUG
        $(document).on("mouseover", "#contenu *", function () {
            console.log($(this).data());
        });

    });


</script>

<body>
<div class="site-container">
	<div id="contenu">
		
	</div>
</div>
</body>
